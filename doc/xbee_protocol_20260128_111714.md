# XBee 통신 프로토콜 문서

## 개요
em_plate_v120 프로젝트의 XBee(ZigBee) 무선 통신 프로토콜 정의서

---

## 1. 통신 설정

### 1.1 UART 스펙

| 항목 | 설정 |
|------|------|
| UART | USART2 |
| Baud Rate | 9600 bps |
| Data Bits | 8 bits |
| Stop Bits | 1 bit |
| Parity | None |
| Flow Control | None |
| DMA | TX/RX 모두 사용 |

### 1.2 기타 설정

| 항목 | 설정 |
|------|------|
| 프로토콜 | 텍스트 기반 (줄 단위, CR/LF) |
| 절전 제어 | OT_ZB_SLEEP GPIO 핀 |
| 오버샘플링 | 16x |

---

## 2. 하드웨어 제어 함수

### xbee_sleep_ctl(uint8_t ctrl)
ZigBee 모듈 절전 제어

| 파라미터 | 동작 |
|----------|------|
| `ctrl = 1` | Wake Up (활성화) |
| `ctrl = 0` | Sleep (절전 모드) |

### xbee_tx(uint8_t *tx_dat, uint16_t size)
UART2를 통해 데이터 전송

---

## 3. 수신 명령어 프로토콜

### 3.1 명령어 목록

| 명령어 | 형식 | 설명 |
|--------|------|------|
| time | `time HH MM` | 측정 시간 설정 |
| open | `open` | 덮개 열기 |
| close | `close` | 덮개 닫기 |
| on | `on` | 시스템 ON (대기 상태) |
| off | `off` | 전원 OFF |
| loop | `loop` | 반복 테스트 모드 |
| type | `type N` | 장치 타입 설정 |
| mode | `mode N` | 동작 모드 설정 |

---

### 3.2 명령어 상세

#### time - 측정 시간 설정
```
형식: time HH MM
파라미터:
  - HH: 시간 (0~23)
  - MM: 분 (0~59)
예시: time 14 30
동작: 자동 모드에서 측정 시작 시간 설정, 플래시에 저장됨
```

#### open - 덮개 열기
```
형식: open
동작: 덮개 열기 동작 시작 (PRC_STRT 상태로 전환)
```

#### close - 덮개 닫기
```
형식: close
동작: 덮개 닫기 동작 시작 (PRC_STOP 상태로 전환)
```

#### on - 시스템 ON
```
형식: on
동작: 시스템 ON, 대기 상태로 전환 (PRC_WAIT 상태, f_proc=1)
```

#### off - 전원 OFF
```
형식: off
동작: 시스템 OFF 상태로 전환 (PRC_OFF 상태)
```

#### loop - 반복 테스트 모드
```
형식: loop
동작: 반복 테스트 모드 시작 (f_break_test=1, PRC_STRT)
```

#### type - 장치 타입 설정
```
형식: type N
파라미터:
  - N=0: 낙하균 (DROP_DEV) - LED 빨강
  - N=1: 표면균 (SURF_DEV) - LED 초록
예시: type 0
동작: 장치 타입 변경, LED 색상 변경, 플래시에 저장됨
```

#### mode - 동작 모드 설정
```
형식: mode N
파라미터:
  - N=0: 수동 모드
  - N=1: 자동 모드
예시: mode 1
동작: 동작 모드 변경, 플래시에 저장됨
```

---

## 4. 상태 코드

| 상태 | 값 | 설명 |
|------|-----|------|
| PRC_INIT | 0x0000 | 초기화 |
| PRC_WAIT | 0x0100 | 대기 |
| PRC_STRT | 0x0200 | 시작 (열기) |
| PRC_STOP | 0x0300 | 정지 (닫기) |
| PRC_OFF | 0x0400 | 전원 OFF |

---

## 5. 통신 예시

### 시간 설정 후 자동 모드로 동작
```
mode 1        <- 자동 모드 설정
time 09 00    <- 오전 9시에 측정 시작
```

### 수동으로 덮개 열고 닫기
```
open          <- 덮개 열기
close         <- 덮개 닫기
```

### 장치 타입 변경
```
type 0        <- 낙하균 모드
type 1        <- 표면균 모드
```

---

## 변경 이력

| 날짜 | 버전 | 내용 |
|------|------|------|
| 2026-01-28 | 1.0 | 최초 작성 |
| 2026-01-28 | 1.1 | on 명령 추가 |
| 2026-01-28 | 1.2 | 통신 스펙 (Baud Rate, Data Format) 추가 |
